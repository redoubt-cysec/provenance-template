name: Python Compatibility Testing

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
      - 'scripts/build_pyz.sh'
      - '.github/workflows/python-compatibility.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'uv.lock'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Quick unit tests on all Python versions
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          python -m pip install --upgrade pip==24.3.1
          pip install uv==0.5.11

      - name: Install dependencies
        run: |
          uv pip install --system -e ".[dev]"

      - name: Run unit tests
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python -m pytest tests/ -v --tb=short

      - name: Test package build
        run: |
          uv build
          ls -lh dist/

  # Docker-based multi-version tests for Linux
  linux-multiversion-tests:
    name: Multi-Version Tests - Linux (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python (for build)
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          python -m pip install --upgrade pip==24.3.1
          pip install uv==0.5.11

      - name: Build .pyz
        run: |
          bash scripts/build_pyz.sh

      - name: Test in Python ${{ matrix.python-version }} container
        run: |
          docker run --rm -v "$(pwd)/dist:/app" python:${{ matrix.python-version }}-slim bash -c '
            cd /app
            echo "=== Testing Python ${{ matrix.python-version }} ==="
            python --version

            echo "Test 1: Version check"
            python provenance-demo.pyz --version || exit 1

            echo "Test 2: Hello command"
            python provenance-demo.pyz hello world || exit 1

            echo "Test 3: Verify command"
            python provenance-demo.pyz verify || exit 1

            echo "✓ All tests passed for Python ${{ matrix.python-version }}"
          '

  # Native multi-version tests for macOS
  macos-multiversion-tests:
    name: Multi-Version Tests - macOS (Python ${{ matrix.python-version }})
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python (for build)
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          python -m pip install --upgrade pip==24.3.1
          pip install uv==0.5.11

      - name: Build .pyz
        run: |
          bash scripts/build_pyz.sh

      - name: Set up test Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Test .pyz with Python ${{ matrix.python-version }}
        run: |
          echo "=== Testing Python ${{ matrix.python-version }} ==="
          python${{ matrix.python-version }} --version

          echo "Test 1: Version check"
          python${{ matrix.python-version }} dist/provenance-demo.pyz --version

          echo "Test 2: Hello command"
          python${{ matrix.python-version }} dist/provenance-demo.pyz hello world

          echo "Test 3: Verify command"
          python${{ matrix.python-version }} dist/provenance-demo.pyz verify

          echo "✓ All tests passed for Python ${{ matrix.python-version }}"

  # Summary job
  compatibility-summary:
    name: Compatibility Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, linux-multiversion-tests, macos-multiversion-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Python Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Linux Multi-Version Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.linux-multiversion-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### macOS Multi-Version Tests" >> $GITHUB_STEP_SUMMARY
          echo "Status: ${{ needs.macos-multiversion-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.linux-multiversion-tests.result }}" != "success" ] || \
             [ "${{ needs.macos-multiversion-tests.result }}" != "success" ]; then
            echo "⚠️ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Python versions tested: 3.10, 3.11, 3.12, 3.13" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "✅ **All Python versions (3.10-3.13) are compatible!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested on:" >> $GITHUB_STEP_SUMMARY
          echo "- Linux (Docker containers with Python 3.10-3.13)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS (Native Python 3.10-3.13)" >> $GITHUB_STEP_SUMMARY
