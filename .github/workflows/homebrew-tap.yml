name: Homebrew Tap Update

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., v0.1.0)'
        required: true
      tap_repo:
        description: 'Tap repository (e.g., Borduas-Holdings/homebrew-tap)'
        required: true
        default: 'Borduas-Holdings/homebrew-tap'

permissions:
  contents: read

jobs:
  update-formula:
    name: Update Homebrew Formula
    runs-on: macos-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set version
        id: version
        run: |
          VERSION="${{ github.event.release.tag_name || inputs.version }}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Checkout tap repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ inputs.tap_repo || 'Borduas-Holdings/homebrew-tap' }}
          path: tap
          token: ${{ secrets.TAP_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Download release artifact
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="${{ github.repository }}"

          # Download the .pyz file
          curl -fsSL -o redoubt.pyz \
            "https://github.com/${REPO}/releases/download/${VERSION}/provenance-template.pyz"

          # Calculate SHA256
          SHA256=$(shasum -a 256 redoubt.pyz | awk '{print $1}')
          echo "sha256=${SHA256}" >> $GITHUB_ENV

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version_number }}"
          SHA256="${{ env.sha256 }}"
          REPO="${{ github.repository }}"

          FORMULA_FILE="tap/Formula/redoubt.rb"

          # Create or update formula
          cat > "$FORMULA_FILE" <<'EOF'
          class Redoubt < Formula
            desc "Supply chain security verification tool"
            homepage "https://github.com/${{ github.repository }}"
            url "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version_number }}/redoubt-release-template.pyz"
            sha256 "${{ env.sha256 }}"
            version "${{ steps.version.outputs.version_number }}"
            license "MIT"

            depends_on "python@3.11"

            def install
              bin.install "redoubt-release-template.pyz" => "redoubt"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/redoubt --version")
            end
          end
          EOF

          # Show the updated formula
          cat "$FORMULA_FILE"

      - name: Commit and push formula
        working-directory: tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/redoubt.rb

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Update redoubt to v${{ steps.version.outputs.version_number }}

          - SHA256: ${{ env.sha256 }}
          - Release: ${{ steps.version.outputs.version }}

          Auto-updated by GitHub Actions"

          git push

      - name: Test formula
        run: |
          cd tap
          brew install --build-from-source Formula/redoubt.rb
          redoubt --version
          redoubt hello "Homebrew CI"

      - name: Create summary
        if: always()
        run: |
          echo "## Homebrew Formula Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256:** \`${{ env.sha256 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install command:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "brew tap ${{ inputs.tap_repo || 'Borduas-Holdings/homebrew-tap' }}" >> $GITHUB_STEP_SUMMARY
          echo "brew install redoubt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
